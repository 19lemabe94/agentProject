
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB Controle Semanal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="/src/New folder/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/src/New folder/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/src/New folder/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <style>
        :root {
            /* TEMA DARK */
            --bg-body: #0d0d0d;
            --bg-sidebar: #000000;
            --bg-card: #141414;
            --text-primary: #e0e0e0;
            --text-secondary: #888888;
            --accent: #ffffff;
            --border: #333333;
            --revision-bg: rgba(255, 255, 255, 0.05);
            --header-bg: #1a1a1a;
            --chart-grid: #333;
            --danger: #ff4444; /* Vermelho para erro/exclusão */
            --overlay: rgba(0, 0, 0, 0.8);
        }

        body.light-mode {
            /* TEMA LIGHT */
            --bg-body: #f5f5f5;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #000000;
            --border: #e0e0e0;
            --revision-bg: rgba(0, 0, 0, 0.03);
            --header-bg: #f0f0f0;
            --chart-grid: #eee;
            --danger: #d32f2f;
            --overlay: rgba(255, 255, 255, 0.8);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: row; 
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- SIDEBAR --- */
        .sidebar img {
            margin : auto;

        } 
        
        .sidebar { 
            width: 260px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 30px 20px; flex-shrink: 0; z-index: 10; margin:auto;
        }
        .brand { margin-bottom: 40px; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .brand h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; color: var(--accent); letter-spacing: 1px; }
        .brand span { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 2px; }
        .menu-item { 
            padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: all 0.2s;
        }
        .menu-item:hover, .menu-item.active { background: var(--bg-card); color: var(--accent); }
        .menu-item svg { width: 20px; height: 20px; stroke: currentColor; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .icon-row { display: flex; gap: 20px; }
        .icon-btn { 
            background: none; border: none; cursor: pointer; opacity: 0.4; padding: 5px; position: relative; transition: all 0.2s; color: var(--text-primary);
        }
        .icon-btn.active, .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .icon-btn svg { width: 22px; height: 22px; stroke: currentColor; fill: none; }
        .icon-btn:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; pointer-events: none; margin-bottom: 5px;
        }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; color: var(--accent); }

        /* --- TABELA --- */
        .excel-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; font-size: 0.9rem; }
        th { background: var(--header-bg); color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 12px 8px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); text-align: center; }
        th:first-child { text-align: left; padding-left: 15px; }
        td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 0; height: 35px; }
        .row-day-start { border-top: 2px solid var(--border); }
        .day-label { writing-mode: vertical-lr; transform: rotate(180deg); text-align: center; font-weight: 800; letter-spacing: 2px; color: var(--accent); padding: 10px 0; height: 100%; display: flex; align-items: center; justify-content: center; width: 30px; margin: 0 auto; }
        .row-revision td { background-color: var(--revision-bg); }
        .row-revision input { font-style: italic; color: var(--text-secondary); }
        input { width: 100%; height: 100%; background: transparent; border: none; color: var(--text-primary); font-family: 'Inter', sans-serif; font-size: 0.9rem; padding: 0 8px; text-align: center; }
        input.text-left { text-align: left; }
        input:focus { background: rgba(255, 255, 255, 0.05); }
        tfoot { background: var(--header-bg); font-weight: 700; border-top: 2px solid var(--accent); }
        tfoot td { padding: 10px 5px; text-align: center; color: var(--accent); }

        /* --- CONTROLES DA SEMANA --- */
        .week-control { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; background: var(--bg-card); padding: 8px 15px; border: 1px solid var(--border); border-radius: 8px; width: fit-content; margin-left: auto; margin-right: auto; }
        .week-btn { background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer; padding: 5px 10px; display: flex; align-items: center; justify-content: center;}
        .week-btn:hover { color: var(--accent); }
        .week-display { font-family: 'Playfair Display', serif; font-weight: 700; color: var(--accent); margin: 0 10px; min-width: 100px; text-align: center; }
        .btn-add { font-size: 0.8rem; border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px; }
        .btn-delete { color: var(--text-secondary); transition: 0.2s; }
        .btn-delete:hover { color: var(--danger); }

        /* --- DASHBOARD --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 25px; display: flex; flex-direction: column; gap: 10px; position: relative; overflow: hidden; }
        .kpi-icon { position: absolute; top: 20px; right: 20px; opacity: 0.1; color: var(--accent); }
        .kpi-icon svg { width: 60px; height: 60px; }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; z-index: 1; }
        .kpi-value { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--accent); font-weight: 700; z-index: 1; line-height: 1; }
        .kpi-sub { font-size: 0.85rem; color: var(--text-secondary); z-index: 1; }
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; height: 350px; }
        .chart-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); margin-bottom: 15px; }

        /* --- MODAL CONFIRMAÇÃO --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay);
            z-index: 999;
            display: none;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border);
            max-width: 400px; width: 90%;
            text-align: center;
            transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-overlay.open .modal-box { transform: translateY(0); }
        .modal-icon { color: var(--danger); margin-bottom: 15px; }
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--accent); margin-bottom: 10px; margin-top: 0; }
        .modal-text { color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9rem; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); }
        .btn-confirm { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3); }
        .btn-confirm:hover { filter: brightness(1.1); transform: translateY(-2px); }

        /* --- MOBILE --- */
        .mobile-menu-toggle { display: none; font-size: 1.5rem; color: var(--accent); cursor: pointer; }
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; flex-direction: row; padding: 10px 15px; border-right: none; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; height: 60px; position: fixed; top: 0; background: var(--bg-sidebar); }
            .sidebar .brand { border: none; margin: 0; padding: 0; text-align: left; }
            .sidebar .brand h1 { font-size: 1.2rem; } .sidebar .brand span { display: none; }
            .mobile-menu-toggle { display: block; }
            .nav-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: var(--bg-body); z-index: 99; padding: 20px; display: none; flex-direction: column; }
            .nav-container.open { display: flex; }
            .sidebar-footer { margin-top: auto; border: none; }
            .main-content { padding: 80px 10px 20px 10px; overflow: visible; }
            .header-bar { flex-direction: column; gap: 10px; align-items: flex-start; }
            .week-control { width: 100%; justify-content: space-between; }
            th, td { font-size: 0.8rem; padding: 5px; } input { font-size: 0.8rem; }
            .charts-row { grid-template-columns: 1fr; }
        }
        @media (min-width: 769px) { .nav-container { display: flex; flex-direction: column; height: 100%; width: 100%; } }
    </style>
</head>
<body class="dark-mode">

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </div>
            <h3 class="modal-title">Excluir Semana?</h3>
            <p class="modal-text">Você está prestes a apagar todos os dados desta semana. Esta ação é irreversível.</p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmDeleteWeek()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" onchange="importData(this)">

    <aside class="sidebar">
        <img src="/src/logobbblack.jpg" alt="Logo BB" style="width:70px;height:70px;"> 
        <div class="brand">
            <h1>BB COMANDO</h1>
            <span>Agente de Tecnologia</span>
        </div>
        <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</div>

        <div class="nav-container" id="navMenu">
            <div class="menu-item active" onclick="switchView('table')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM3 9h18M3 15h18M9 3v18M15 3v18"/></svg>
                Planilha Semanal
            </div>
            <div class="menu-item" onclick="switchView('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                Dashboard
            </div>

            <div class="sidebar-footer">
                <div class="icon-row">
                    <button class="icon-btn" onclick="exportData()" data-tooltip="Baixar Backup">
                        <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    </button>
                    <button class="icon-btn" onclick="document.getElementById('fileInput').click()" data-tooltip="Restaurar Backup">
                        <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                    </button>
                </div>
                <div class="icon-row">
                    <button class="icon-btn active" id="btnDark" onclick="setTheme('dark')" data-tooltip="Modo Escuro">
                        <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="icon-btn" id="btnLight" onclick="setTheme('light')" data-tooltip="Modo Claro">
                        <svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line></svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        
        <div id="view-table" class="view-section active">
            <div class="header-bar">
                <h2 class="page-title">Cronograma</h2>
                <div class="week-control">
                    <button class="week-btn" onclick="changeWeek(-1)">❮</button>
                    <span class="week-display" id="weekDisplay">SEMANA 1</span>
                    <button class="week-btn" onclick="changeWeek(1)">❯</button>
                    
                    <button class="week-btn btn-delete" onclick="openDeleteModal()" title="Excluir Semana Atual">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                    <button class="week-btn btn-add" onclick="addWeek()">+ Nova</button>
                </div>
            </div>

            <div class="excel-container">
                <div class="table-scroll">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">DIA</th>
                                <th style="width: 180px;">DISCIPLINA</th>
                                <th style="width: 60px;">CARGA</th>
                                <th style="width: 150px;">AULA / TÓPICO</th>
                                <th style="width: 60px;">P. INI</th>
                                <th style="width: 60px;">P. FIM</th>
                                <th style="width: 60px;">QUEST.</th>
                                <th style="width: 60px;">ACERT.</th>
                                <th style="width: 60px;">%</th>
                                <th style="width: 80px;">H. LIQ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                        <tfoot id="tableFooter"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section">
            <h2 class="page-title" style="margin-bottom: 30px;">Performance Global</h2>
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div>
                    <div class="kpi-label">Questões Totais</div>
                    <div class="kpi-value" id="kpiQTotal">0</div>
                    <div class="kpi-sub">Resolvidas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg></div>
                    <div class="kpi-label">Horas Líquidas</div>
                    <div class="kpi-value" id="kpiHTotal">0h 0m</div>
                    <div class="kpi-sub">Estudadas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                    <div class="kpi-label">Páginas Lidas</div>
                    <div class="kpi-value" id="kpiPTotal">0</div>
                    <div class="kpi-sub">PDF/Livros</div>
                </div>
            </div>
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-title">Progresso Diário (Semana Atual)</div>
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Precisão Global</div>
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
             <div class="charts-row">
                <div class="chart-card" style="grid-column: span 2;">
                    <div class="chart-title">Evolução de Acertos (Semanal)</div>
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <script>
        const dayConfig = ['SEG','TER','QUA','QUI','SEX','SAB'];
        let appData = { currentWeekIndex: 0, weeks: [] };
        let charts = {};

        function init() {
            const stored = localStorage.getItem('bb_omnisync_v9');
            if (stored) appData = JSON.parse(stored); else createNewWeek();
            const theme = localStorage.getItem('bb_theme') || 'dark'; setTheme(theme);
            renderTable();
        }

        // --- MANIPULAÇÃO DE DADOS ---
        function createNewWeek() {
            let newRows = [];
            dayConfig.forEach(day => {
                for(let i=0; i<4; i++) newRows.push(createRowObj(day, '60', 'standard'));
                newRows.push(createRowObj(day, '30', 'revision'));
            });
            newRows.push(createRowObj('DOM', 'SIMULADO', 'sunday'));
            appData.weeks.push(newRows);
            appData.currentWeekIndex = appData.weeks.length - 1;
            save();
        }

        function createRowObj(day, load, type) {
            return { day, load, type, subject: type==='revision'?'REVISÃO':(type==='sunday'?'SIMULADO / REVISÃO':''), topic:'', pStart:'', pEnd:'', qTotal:'', qCorrect:'', hNet:'' };
        }

        function save() {
            localStorage.setItem('bb_omnisync_v9', JSON.stringify(appData));
            updateTotals();
        }

        // --- RENDER ---
        function renderTable() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            if(appData.weeks.length === 0) { createNewWeek(); return; } // Segurança
            
            // Ajustar index se estiver fora do range
            if (appData.currentWeekIndex >= appData.weeks.length) appData.currentWeekIndex = appData.weeks.length - 1;
            if (appData.currentWeekIndex < 0) appData.currentWeekIndex = 0;

            const currentRows = appData.weeks[appData.currentWeekIndex];
            document.getElementById('weekDisplay').innerText = `SEMANA ${appData.currentWeekIndex + 1}`;
            let currentDay = '';
            
            currentRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const isNewDay = row.day !== currentDay;
                if (isNewDay) { tr.classList.add('row-day-start'); currentDay = row.day; }
                if (row.type === 'revision') tr.classList.add('row-revision');
                if (row.type === 'sunday') tr.style.backgroundColor = 'var(--bg-card)';
                let dayHtml = '';
                if (isNewDay) { const span = row.day === 'DOM' ? 1 : 5; dayHtml = `<td rowspan="${span}" style="vertical-align: middle; border-right: 2px solid var(--border);"><div class="day-label">${row.day}</div></td>`; }
                let pct='-', color='var(--text-secondary)';
                if(row.qTotal>0 && row.qCorrect!==''){ const val=Math.round((parseInt(row.qCorrect)/parseInt(row.qTotal))*100); pct=val+'%'; if(val>=80)color='#4caf50'; else if(val>=60)color='#ffeb3b'; else color='#f44336'; }
                let html = dayHtml + `<td><input type="text" class="text-left" value="${row.subject}" onchange="updateRow(${idx}, 'subject', this.value)" placeholder="..."></td><td style="text-align:center; color: var(--text-secondary); font-size: 0.8rem;">${row.load}</td><td><input type="text" class="text-left" value="${row.topic}" onchange="updateRow(${idx}, 'topic', this.value)"></td><td><input type="number" value="${row.pStart}" onchange="updateRow(${idx}, 'pStart', this.value)"></td><td><input type="number" value="${row.pEnd}" onchange="updateRow(${idx}, 'pEnd', this.value)"></td><td><input type="number" value="${row.qTotal}" onchange="updateRow(${idx}, 'qTotal', this.value)"></td><td><input type="number" value="${row.qCorrect}" onchange="updateRow(${idx}, 'qCorrect', this.value)"></td><td style="text-align:center; color:${color}; font-weight:bold;">${pct}</td><td><input type="text" placeholder="00:00" value="${row.hNet}" onchange="updateRow(${idx}, 'hNet', this.value)"></td>`;
                tr.innerHTML = html; tbody.appendChild(tr);
            });
            updateTotals();
        }

        window.updateRow = function(idx, field, val) { appData.weeks[appData.currentWeekIndex][idx][field] = val; save(); renderTable(); };

        function updateTotals() {
            if(appData.weeks.length === 0) return;
            const rows = appData.weeks[appData.currentWeekIndex];
            let tPages=0, tQuest=0, tCorrect=0, tMinutes=0;
            rows.forEach(r => {
                if(r.pEnd && r.pStart) tPages += (parseInt(r.pEnd)-parseInt(r.pStart));
                if(r.qTotal) tQuest += parseInt(r.qTotal); if(r.qCorrect) tCorrect += parseInt(r.qCorrect);
                if(r.hNet){ if(r.hNet.includes(':')){const p=r.hNet.split(':'); tMinutes+=(parseInt(p[0])*60)+parseInt(p[1]);}else{tMinutes+=parseFloat(r.hNet)*60;}}
            });
            const tPct = tQuest>0 ? Math.round((tCorrect/tQuest)*100)+'%' : '-';
            const hTotal=Math.floor(tMinutes/60), mTotal=Math.round(tMinutes%60), timeStr=`${hTotal}h ${mTotal}m`;
            document.getElementById('tableFooter').innerHTML = `<tr><td colspan="4" style="text-align:right; padding-right:15px; color:var(--text-primary);">TOTAL SEMANAL</td><td>-</td><td>${tPages}pg</td><td>${tQuest}</td><td>${tCorrect}</td><td>${tPct}</td><td>${timeStr}</td></tr>`;
        }

        // --- EXCLUSÃO (NOVO MODAL) ---
        window.openDeleteModal = function() {
            if (appData.weeks.length <= 1) {
                alert("Você não pode excluir a única semana restante.");
                return;
            }
            document.getElementById('deleteModal').classList.add('open');
        };

        window.closeModal = function() {
            document.getElementById('deleteModal').classList.remove('open');
        };

        window.confirmDeleteWeek = function() {
            // Remove a semana atual
            appData.weeks.splice(appData.currentWeekIndex, 1);
            
            // Ajusta o index se necessário (se apagou a última, volta uma)
            if (appData.currentWeekIndex >= appData.weeks.length) {
                appData.currentWeekIndex = appData.weeks.length - 1;
            }
            
            save();
            renderTable();
            closeModal();
            if(document.getElementById('view-dashboard').classList.contains('active')) updateDashboard();
        };

        // --- DASHBOARD ---
        function updateDashboard() {
            let gQuest=0, gCorrect=0, gPages=0, gMinutes=0;
            const weeklyAcc = [], dailyQ = {'SEG':0,'TER':0,'QUA':0,'QUI':0,'SEX':0,'SAB':0,'DOM':0};
            appData.weeks.forEach((week, wIdx) => {
                let wQ=0, wC=0;
                week.forEach(r => {
                    const q=parseInt(r.qTotal)||0, c=parseInt(r.qCorrect)||0;
                    gQuest+=q; gCorrect+=c; wQ+=q; wC+=c;
                    if(r.pEnd && r.pStart) gPages+=(parseInt(r.pEnd)-parseInt(r.pStart));
                    if(r.hNet){ if(r.hNet.includes(':')){const p=r.hNet.split(':'); gMinutes+=(parseInt(p[0])*60)+parseInt(p[1]);}else{gMinutes+=parseFloat(r.hNet)*60;}}
                    if(wIdx === appData.currentWeekIndex && dailyQ[r.day] !== undefined) dailyQ[r.day] += q;
                });
                weeklyAcc.push({ label:`S${wIdx+1}`, acc: wQ>0 ? Math.round((wC/wQ)*100) : 0 });
            });
            document.getElementById('kpiQTotal').innerText = gQuest; document.getElementById('kpiPTotal').innerText = gPages;
            const h=Math.floor(gMinutes/60), m=Math.round(gMinutes%60); document.getElementById('kpiHTotal').innerText = `${h}h ${m}m`;
            renderCharts(gQuest, gCorrect, dailyQ, weeklyAcc);
        }

        function renderCharts(total, correct, dailyData, weeklyData) {
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--chart-grid').trim();
            const accent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
            Chart.defaults.color = textColor; Chart.defaults.borderColor = gridColor; Chart.defaults.font.family = "'Inter', sans-serif";
            
            const ctxAcc = document.getElementById('accuracyChart').getContext('2d');
            if(charts.acc) charts.acc.destroy();
            charts.acc = new Chart(ctxAcc, { type: 'doughnut', data: { labels: ['Acertos', 'Erros'], datasets: [{ data: [correct, total-correct], backgroundColor: ['#4caf50', '#f44336'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' } });

            const ctxDaily = document.getElementById('dailyChart').getContext('2d');
            if(charts.daily) charts.daily.destroy();
            charts.daily = new Chart(ctxDaily, { type: 'bar', data: { labels: Object.keys(dailyData), datasets: [{ label: 'Questões', data: Object.values(dailyData), backgroundColor: accent, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}} } });

            const ctxEvo = document.getElementById('evolutionChart').getContext('2d');
            if(charts.evo) charts.evo.destroy();
            charts.evo = new Chart(ctxEvo, { type: 'line', data: { labels: weeklyData.map(d=>d.label), datasets: [{ label: '% Acerto', data: weeklyData.map(d=>d.acc), borderColor: accent, backgroundColor: accent, tension: 0.3, pointRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{min:0, max:100, ticks:{callback:v=>v+'%'}}} } });
        }

        // --- UX ---
        window.changeWeek = function(dir) { const next=appData.currentWeekIndex+dir; if(next>=0 && next<appData.weeks.length){appData.currentWeekIndex=next; renderTable();} };
        window.addWeek = function() { if(confirm("Iniciar nova semana?")){ createNewWeek(); renderTable(); } };
        window.switchView = function(view) { document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active')); document.getElementById('view-'+view).classList.add('active'); event.currentTarget.classList.add('active'); document.getElementById('navMenu').classList.remove('open'); if(view === 'dashboard') updateDashboard(); };
        window.toggleMobileMenu = function() { document.getElementById('navMenu').classList.toggle('open'); };
        window.setTheme = function(mode) { if(mode==='light') document.body.classList.add('light-mode'); else document.body.classList.remove('light-mode'); document.querySelectorAll('.icon-btn').forEach(b=>b.classList.remove('active')); document.getElementById(mode==='light'?'btnLight':'btnDark').classList.add('active'); localStorage.setItem('bb_theme', mode); if(document.getElementById('view-dashboard').classList.contains('active')) updateDashboard(); };
        window.exportData = function() { const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData)), a=document.createElement('a'); a.href=d; a.download=`BB_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); };
        window.importData = function(i) { const f=i.files[0], r=new FileReader(); r.onload=function(e){try{const j=JSON.parse(e.target.result); if(j.weeks){appData=j; save(); renderTable(); alert("Backup restaurado!");}else alert("Arquivo inválido.");}catch(e){alert("Erro ao ler arquivo.");}}; if(f)r.readAsText(f); };

        init();
    </script>
</body>
</html>