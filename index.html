<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB AGENT DREAM - V15 UI Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* DARK THEME */
            --bg-body: #0d0d0d; --bg-sidebar: #000000; --bg-card: #141414;
            --text-primary: #e0e0e0; --text-secondary: #888888;
            --accent: #ffffff; --border: #333333;
            --revision-bg: rgba(255, 255, 255, 0.05);
            --header-bg: #1a1a1a; 
            --danger: #ff4444; --success: #4caf50; --info: #2196f3; --warning: #ff9800;
            --chart-grid: #333; 
            --overlay: rgba(0, 0, 0, 0.85);
        }
        body.light-mode {
            /* LIGHT THEME */
            --bg-body: #f5f5f5; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            --text-primary: #1a1a1a; --text-secondary: #666666;
            --accent: #000000; --border: #e0e0e0;
            --revision-bg: rgba(0, 0, 0, 0.03);
            --header-bg: #f0f0f0; 
            --danger: #d32f2f; --success: #2e7d32; --info: #1976d2; --warning: #f57c00;
            --chart-grid: #ddd; 
            --overlay: rgba(255, 255, 255, 0.85);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-primary); margin: 0; height: 100vh; display: flex; overflow: hidden; transition: 0.3s; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 30px 20px; flex-shrink: 0; z-index: 10; }
        .brand { margin-bottom: 40px; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .brand-logo { width: 70px; height: auto; display: block; margin: 0 auto 15px auto; transition: filter 0.3s; }
        body:not(.light-mode) .brand-logo { filter: invert(1) brightness(2); }
        .brand h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; color: var(--accent); letter-spacing: 1px; }
        .brand span { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 2px; }
        .menu-item { padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--bg-card); color: var(--accent); }
        .menu-item svg { width: 20px; height: 20px; stroke: currentColor; fill: none; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .icon-row { display: flex; gap: 20px; }
        .icon-btn { background: none; border: none; cursor: pointer; opacity: 0.4; padding: 5px; position: relative; color: var(--text-primary); }
        .icon-btn.active, .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .icon-btn svg { width: 22px; height: 22px; stroke: currentColor; fill: none; }

        /* MAIN */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; color: var(--accent); }

        /* TABLES & INPUTS */
        .excel-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 0.9rem; }
        th { background: var(--header-bg); color: var(--text-secondary); padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-size: 0.75rem; }
        td { border: 1px solid var(--border); padding: 0; height: 35px; }
        select { width: 100%; height: 100%; background: transparent; border: none; color: var(--text-primary); padding: 0 5px; cursor: pointer; appearance: none; }
        select option { background: var(--bg-card); color: var(--text-primary); }
        input { width: 100%; height: 100%; background: transparent; border: none; color: var(--text-primary); text-align: center; font-size: 0.9rem; }
        
        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        .kpi-val { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
        .kpi-lbl { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; height: 300px; }
        .chart-title { font-size: 1rem; color: var(--accent); margin-bottom: 15px; font-weight: 600; }
        .topics-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .topics-table th { text-align: left; background: var(--header-bg); padding: 8px; color: var(--text-secondary); }
        .topics-table td { border-bottom: 1px solid var(--border); padding: 8px; color: var(--text-secondary); }
        .topics-table td:first-child { color: var(--text-primary); }

        /* EDITAL */
        .edital-container { display: flex; flex-direction: column; gap: 20px; }
        .discipline-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .discipline-header { padding: 15px 20px; background: var(--header-bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .topic-list { display: none; padding: 0; margin: 0; list-style: none; }
        .topic-list.open { display: block; }
        .topic-item { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 15px; align-items: center; justify-content: space-between; }
        .topic-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .topic-check { appearance: none; width: 18px; height: 18px; border: 1px solid var(--text-secondary); border-radius: 4px; cursor: pointer; flex-shrink: 0; }
        .topic-check:checked { background: var(--success); border-color: var(--success); }
        .topic-text { font-size: 0.9rem; }
        .topic-check:checked + .topic-text { text-decoration: line-through; opacity: 0.5; }
        .time-badge { font-size: 0.75rem; background: var(--border); padding: 4px 8px; border-radius: 4px; color: var(--text-secondary); min-width: 50px; text-align: center; }
        .time-badge.has-time { background: rgba(33, 150, 243, 0.15); color: var(--info); border: 1px solid var(--info); font-weight: 700; }
        .add-btn-mini { opacity: 0; background: none; border: 1px solid var(--border); color: var(--accent); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .topic-item:hover .add-btn-mini { opacity: 1; }

        /* FUTURE TAB */
        .future-hero { text-align: center; padding: 50px 20px; border: 1px dashed var(--border); border-radius: 12px; margin-bottom: 30px; background: rgba(255,255,255,0.01); }
        .future-title { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--accent); margin-bottom: 10px; }
        .future-sub { color: var(--text-secondary); margin-bottom: 30px; }
        .notes-area { width: 100%; height: 400px; background: var(--bg-card); border: 1px solid var(--border); padding: 25px; color: var(--text-primary); font-family: 'Inter', sans-serif; resize: none; border-radius: 8px; font-size: 1rem; line-height: 1.6; }
        .notes-area:focus { border-color: var(--accent); }

        .week-control { display: flex; gap: 10px; align-items: center; background: var(--bg-card); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); }
        .week-btn { background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 4px; transition: 0.2s; }
        .week-btn:hover { background: var(--border); color: var(--accent); }
        .btn-del:hover { color: var(--danger); background: rgba(255,68,68,0.1); }
        
        /* UNIFIED MODAL SYSTEM */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--overlay); z-index: 9999; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal-box { 
            background: var(--bg-card); width: 90%; max-width: 400px; 
            padding: 30px; border-radius: 16px; border: 1px solid var(--border); 
            text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .modal-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--accent); margin: 0 0 10px 0; }
        .modal-text { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 25px; line-height: 1.5; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; min-width: 100px; }
        .btn-modal:active { transform: scale(0.98); }
        
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
        
        .btn-confirm { color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-confirm:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        /* Cores Din√¢micas do Modal */
        .modal-danger .btn-confirm { background: var(--danger); }
        .modal-danger .modal-icon { color: var(--danger); }
        
        .modal-info .btn-confirm { background: var(--info); }
        .modal-info .modal-icon { color: var(--info); }
        
        .modal-success .btn-confirm { background: var(--success); }
        .modal-success .modal-icon { color: var(--success); }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; }
            .sidebar { width: 100%; flex-direction: row; height: 60px; padding: 10px 15px; position: fixed; top: 0; align-items: center; justify-content: space-between; }
            .brand-logo { display: none; } .brand { border: none; margin: 0; padding: 0; display: flex; align-items: center; gap: 10px; } .brand span { display: none; } .brand h1 { font-size: 1.2rem; margin: 0; }
            .main-content { padding-top: 80px; }
            .charts-container { grid-template-columns: 1fr; }
            #navMenu { display: none; position: fixed; top: 60px; left: 0; width: 100%; height: calc(100vh - 60px); background: var(--bg-body); flex-direction: column; padding: 20px; }
            #navMenu.open { display: flex; }
            .mobile-toggle { display: block; font-size: 1.5rem; color: var(--accent); }
        }
        @media (min-width: 769px) { .mobile-toggle { display: none; } #navMenu { display: flex !important; flex-direction: column; height: 100%; } }
    </style>
</head>
<body class="dark-mode">

    <div id="genericModal" class="modal-overlay">
        <div class="modal-box" id="modalBox">
            <span id="modalIcon" class="modal-icon"></span>
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalText" class="modal-text"></p>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="brand">
            <img src="https://cdn.freebiesupply.com/logos/large/2x/banco-do-brasil-01-logo-black-and-white.png" alt="BB Logo" class="brand-logo">
            <h1>ESCRITU√ÅRIO BB</h1>
            <span>Agente de Tecnologia</span>
        </div>
        <div class="mobile-toggle" onclick="document.getElementById('navMenu').classList.toggle('open')">‚ò∞</div>
        
        <div id="navMenu">
            <div class="menu-item active" onclick="switchView('table')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM3 9h18M3 15h18M9 3v18M15 3v18"/></svg>Cronograma</div>
            <div class="menu-item" onclick="switchView('dashboard')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>Analytics</div>
            <div class="menu-item" onclick="switchView('edital')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Edital 2022</div>
            <div class="menu-item" onclick="switchView('future')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Futuro 2026</div>
            
            <div class="sidebar-footer">
                <div class="icon-row">
                    <button class="icon-btn" onclick="exportData()"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
                    <button class="icon-btn" onclick="document.getElementById('fileInput').click()"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg></button>
                </div>
                <div class="icon-row">
                    <button class="icon-btn active" id="btnDark" onclick="setTheme('dark')"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button>
                    <button class="icon-btn" id="btnLight" onclick="setTheme('light')"><svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line></svg></button>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div id="view-table" class="view-section active">
            <div class="header-bar">
                <h2 class="page-title">Cronograma</h2>
                <div class="week-control">
                    <button class="week-btn" onclick="changeWeek(-1)">‚ùÆ</button>
                    <span id="weekDisplay" style="font-weight:700; color:var(--accent);">SEMANA 1</span>
                    <button class="week-btn" onclick="changeWeek(1)">‚ùØ</button>
                    <button class="week-btn btn-del" onclick="askDeleteWeek()" style="color:var(--danger)">üóëÔ∏è</button>
                    <button class="week-btn" onclick="askAddWeek()">+</button>
                </div>
            </div>
            <div class="excel-container"><div class="table-scroll"><table id="mainTable"><thead><tr><th style="width:40px">DIA</th><th style="width:200px">DISCIPLINA</th><th style="width:60px">CARGA</th><th style="width:200px">T√ìPICO</th><th>P.INI</th><th>P.FIM</th><th>Q.TOT</th><th>Q.OK</th><th>%</th><th>H.LIQ</th></tr></thead><tbody id="tableBody"></tbody></table></div></div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div class="header-bar"><h2 class="page-title">Analytics</h2></div>
            <div class="dashboard-grid">
                <div class="kpi-card"><div class="kpi-lbl">Horas Totais</div><div class="kpi-val" id="dashH">0h</div></div>
                <div class="kpi-card"><div class="kpi-lbl">Quest√µes</div><div class="kpi-val" id="dashQ">0</div></div>
                <div class="kpi-card"><div class="kpi-lbl">Precis√£o Global</div><div class="kpi-val" id="dashAcc">0%</div></div>
                <div class="kpi-card"><div class="kpi-lbl">T√≥picos Vencidos</div><div class="kpi-val" id="dashTop">0</div></div>
            </div>
            <div class="charts-container">
                <div class="chart-box"><div class="chart-title">Horas por Disciplina</div><canvas id="chartHours"></canvas></div>
                <div class="chart-box"><div class="chart-title">Quest√µes por Disciplina</div><canvas id="chartQuestions"></canvas></div>
            </div>
            <div class="chart-box" style="height: auto;">
                <div class="chart-title">Efici√™ncia por T√≥pico (Top 10)</div>
                <table class="topics-table"><thead><tr><th>T√≥pico</th><th>Quest√µes</th><th>Acertos</th><th>%</th></tr></thead><tbody id="topTopicsBody"></tbody></table>
            </div>
        </div>

        <div id="view-edital" class="view-section">
            <div class="header-bar"><h2 class="page-title">Edital 2022</h2></div>
            <div class="edital-container" id="editalContainer"></div>
        </div>

        <div id="view-future" class="view-section">
            <div class="header-bar"><h2 class="page-title">Pr√≥ximo Edital 2026</h2></div>
            <div class="future-hero"><div class="future-title">Miss√£o Futura</div><div class="future-sub">Planejamento estrat√©gico de longo prazo</div></div>
            <h3 style="color:var(--accent); margin-bottom:15px;">Di√°rio de Estrat√©gia</h3>
            <textarea class="notes-area" id="futureNotes" placeholder="Registre aqui rumores de banca, novas tecnologias..." oninput="saveNotes(this.value)"></textarea>
        </div>
    </main>

    <input type="file" id="fileInput" style="display:none;" onchange="importData(this)">

    <script>
        // --- BASE DE DADOS ---
        const editalDB = {
            "L√≠ngua Portuguesa": ["Compreens√£o de textos", "Ortografia oficial", "Classe de palavras", "Crase", "Sintaxe", "Pontua√ß√£o", "Concord√¢ncia", "Reg√™ncia", "Coloca√ß√£o pronominal"],
            "Matem√°tica": ["N√∫meros inteiros/racionais", "Medidas", "Raz√µes e propor√ß√µes", "L√≥gica proposicional", "Conjuntos", "Fun√ß√µes", "Matrizes", "Determinantes", "Sistemas lineares", "Sequ√™ncias (PA/PG)"],
            "Atualidades do Mercado": ["Bancos na Era Digital", "Internet/Mobile Banking", "Open Banking", "Fintechs/Startups", "Shadow banking", "Criptomoedas/Blockchain", "PIX", "Transforma√ß√£o digital"],
            "Probabilidade e Estat√≠stica": ["Representa√ß√£o gr√°fica", "M√©dia/Mediana/Moda", "Vari√¢ncia/Desvio Padr√£o", "Probabilidade", "Teorema de Bayes", "Distribui√ß√£o Binomial/Normal", "Infer√™ncia estat√≠stica"],
            "Conhecimentos Banc√°rios": ["SFN - Estrutura", "Mercado financeiro", "Pol√≠tica monet√°ria (SELIC)", "Produtos Banc√°rios", "Mercado de C√¢mbio", "Lavagem de dinheiro", "Sigilo Banc√°rio", "LGPD", "√âtica e Compliance"],
            "Tecnologia da Informa√ß√£o": ["Aprendizagem de m√°quina", "Banco de Dados (SQL/NoSQL)", "Big Data", "Dev Mobile (Java/Kotlin/Swift)", "Estrutura de dados", "Python/Pandas/NumPy"],
            "Ingl√™s": ["Compreens√£o de Texto T√©cnico", "Vocabul√°rio Banc√°rio/TI"],
            "Reda√ß√£o": ["Texto Dissertativo-Argumentativo"]
        };
        const extraSubjects = ["REVIS√ÉO", "SIMULADO"];

        let appData = { currentWeek: 0, weeks: [], editalStatus: {}, futureNotes: "" };
        let charts = {};

        function init() {
            const s = localStorage.getItem('bb_v15_ui');
            if(s) appData = JSON.parse(s); else createWeek();
            setTheme(localStorage.getItem('bb_theme')||'dark');
            renderTable(); renderEdital();
            document.getElementById('futureNotes').value = appData.futureNotes || "";
        }

        // --- SISTEMA DE MODAIS (UI CORE) ---
        function showModal(type, title, text, onConfirm) {
            const overlay = document.getElementById('genericModal');
            const box = document.getElementById('modalBox');
            const icon = document.getElementById('modalIcon');
            const btnArea = document.getElementById('modalActions');
            
            // Reset Classes
            box.className = 'modal-box modal-' + type;
            
            // Icon Logic
            let iconChar = '';
            if(type === 'danger') iconChar = '‚ö†Ô∏è';
            if(type === 'info') iconChar = 'üìÖ';
            if(type === 'success') iconChar = '‚úÖ';
            if(type === 'warning') iconChar = 'üõë';
            icon.innerText = iconChar;

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalText').innerText = text;
            
            // Buttons
            let html = `<button class="btn-modal btn-cancel" onclick="closeModal()">Cancelar</button>`;
            
            // Se for 'success' ou 'warning' (apenas aviso), s√≥ mostra OK
            if(type === 'success' || (type === 'warning' && !onConfirm)) {
                html = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
            } else if (onConfirm) {
                html += `<button id="confirmBtn" class="btn-modal btn-confirm">Confirmar</button>`;
            }
            
            btnArea.innerHTML = html;
            
            if(onConfirm) {
                document.getElementById('confirmBtn').onclick = function() {
                    onConfirm();
                    closeModal();
                };
            }

            overlay.classList.add('open');
        }

        function closeModal() {
            document.getElementById('genericModal').classList.remove('open');
        }

        // --- A√á√ïES DO USU√ÅRIO (VIA MODAL) ---
        window.askAddWeek = function() {
            showModal('info', 'Nova Semana', 'Deseja iniciar uma nova semana no cronograma?', () => {
                createWeek();
                renderTable();
            });
        }

        window.askDeleteWeek = function() {
            if(appData.weeks.length <= 1) {
                showModal('warning', 'A√ß√£o Bloqueada', 'Voc√™ n√£o pode excluir a √∫nica semana existente.');
                return;
            }
            showModal('danger', 'Excluir Semana', 'Voc√™ est√° prestes a apagar todos os dados desta semana. Esta a√ß√£o √© irrevers√≠vel.', () => {
                appData.weeks.splice(appData.currentWeek, 1);
                appData.currentWeek = Math.max(0, appData.currentWeek - 1);
                save(); renderTable();
            });
        }

        window.askAddToPlan = function(disc, topic) {
            showModal('info', 'Agendar T√≥pico', `Deseja adicionar "${topic}" ao primeiro hor√°rio livre da semana atual?`, () => {
                const rows = appData.weeks[appData.currentWeek];
                const slot = rows.find(r => r.topic === "" && r.type === "standard");
                if(slot) {
                    slot.subject = disc; slot.topic = topic;
                    save(); renderTable(); switchView('table');
                } else {
                    showModal('warning', 'Sem Espa√ßo', 'N√£o h√° hor√°rios livres nesta semana.');
                }
            });
        }

        // --- L√ìGICA DO APP ---
        function createWeek() {
            const days = ['SEG','TER','QUA','QUI','SEX','SAB'];
            let rows = [];
            days.forEach(d => {
                for(let i=0; i<4; i++) rows.push(makeRow(d, '60', 'standard'));
                rows.push(makeRow(d, '30', 'revision'));
            });
            rows.push(makeRow('DOM', 'SIMULADO', 'sunday'));
            appData.weeks.push(rows);
            appData.currentWeek = appData.weeks.length - 1;
            save();
        }

        function makeRow(day, load, type) { return { day, load, type, subject: type==='revision'?'REVIS√ÉO':'', topic:'', p1:'', p2:'', qT:'', qC:'', h:'' }; }
        function save() { localStorage.setItem('bb_v15_ui', JSON.stringify(appData)); }
        function saveNotes(val) { appData.futureNotes = val; save(); }

        function calculateTopicHours(topicName) {
            let total = 0;
            appData.weeks.forEach(week => {
                week.forEach(row => {
                    if(row.topic === topicName && row.h) {
                        let val = 0;
                        if(row.h.includes(':')) {
                            const p = row.h.split(':');
                            val = parseInt(p[0]) + (parseInt(p[1])/60);
                        } else { val = parseFloat(row.h); }
                        if(!isNaN(val)) total += val;
                    }
                });
            });
            return total;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            if(!appData.weeks.length) { createWeek(); return; }
            const rows = appData.weeks[appData.currentWeek];
            document.getElementById('weekDisplay').innerText = `SEMANA ${appData.currentWeek + 1}`;
            
            let curDay = '';
            rows.forEach((r, i) => {
                const tr = document.createElement('tr');
                if(r.day !== curDay) { tr.style.borderTop = "2px solid var(--border)"; curDay = r.day; }
                if(r.type === 'revision') tr.style.backgroundColor = "var(--revision-bg)";
                
                let subOpts = `<option value="">Selecione...</option>`;
                [...Object.keys(editalDB), ...extraSubjects].forEach(s => subOpts += `<option value="${s}" ${r.subject===s?'selected':''}>${s}</option>`);
                
                let topOpts = `<option value="">...</option>`;
                if(editalDB[r.subject]) { editalDB[r.subject].forEach(t => topOpts += `<option value="${t}" ${r.topic===t?'selected':''}>${t}</option>`); }
                else if(r.topic) { topOpts += `<option value="${r.topic}" selected>${r.topic}</option>`; }

                let pct = '-'; let col = 'var(--text-secondary)';
                if(r.qT > 0 && r.qC !== '') { const v = Math.round((r.qC/r.qT)*100); pct = v+'%'; if(v>=80) col='var(--success)'; else if(v>=60) col='#ffeb3b'; else col='var(--danger)'; }

                tr.innerHTML = `
                    <td style="font-weight:700; color:var(--accent); text-align:center;">${r.day}</td>
                    <td><select onchange="updateSubject(${i}, this.value)">${subOpts}</select></td>
                    <td style="text-align:center; color:var(--text-secondary);">${r.load}</td>
                    <td><select onchange="upd(${i},'topic',this.value)">${topOpts}</select></td>
                    <td><input type="number" value="${r.p1}" onchange="upd(${i},'p1',this.value)"></td>
                    <td><input type="number" value="${r.p2}" onchange="upd(${i},'p2',this.value)"></td>
                    <td><input type="number" value="${r.qT}" onchange="upd(${i},'qT',this.value)"></td>
                    <td><input type="number" value="${r.qC}" onchange="upd(${i},'qC',this.value)"></td>
                    <td style="text-align:center; color:${col}; font-weight:700;">${pct}</td>
                    <td><input value="${r.h}" onchange="upd(${i},'h',this.value)"></td>`;
                tbody.appendChild(tr);
            });
            updateDashboard(); 
        }

        window.upd = function(i, k, v) { appData.weeks[appData.currentWeek][i][k] = v; save(); renderTable(); }
        window.updateSubject = function(i, val) { appData.weeks[appData.currentWeek][i].subject = val; appData.weeks[appData.currentWeek][i].topic = ''; save(); renderTable(); }
        window.changeWeek = function(d) { const n = appData.currentWeek + d; if(n >= 0 && n < appData.weeks.length) { appData.currentWeek = n; renderTable(); } }

        function updateDashboard() {
            let totalH=0, totalQ=0, totalC=0;
            let subStats = {}; let topicStats = {};
            appData.weeks.forEach(w => {
                w.forEach(r => {
                    const q = parseInt(r.qT)||0; const c = parseInt(r.qC)||0;
                    let h = 0;
                    if(r.h && r.h.includes(':')) { const p = r.h.split(':'); h = parseInt(p[0]) + (parseInt(p[1])/60); } 
                    else { h = parseFloat(r.h)||0; }
                    totalH += h; totalQ += q; totalC += c;
                    if(r.subject && !extraSubjects.includes(r.subject)) {
                        if(!subStats[r.subject]) subStats[r.subject] = {h:0, q:0, c:0};
                        subStats[r.subject].h += h; subStats[r.subject].q += q; subStats[r.subject].c += c;
                        if(r.topic) {
                            if(!topicStats[r.topic]) topicStats[r.topic] = {q:0, c:0};
                            topicStats[r.topic].q += q; topicStats[r.topic].c += c;
                        }
                    }
                });
            });
            document.getElementById('dashH').innerText = totalH.toFixed(1) + 'h';
            document.getElementById('dashQ').innerText = totalQ;
            document.getElementById('dashAcc').innerText = totalQ>0 ? Math.round((totalC/totalQ)*100)+'%' : '0%';
            document.getElementById('dashTop').innerText = Object.values(appData.editalStatus).filter(Boolean).length;
            renderCharts(subStats); renderTopicTable(topicStats);
        }

        function renderCharts(stats) {
            const labels = Object.keys(stats);
            const dataH = labels.map(k => stats[k].h);
            const dataQ = labels.map(k => stats[k].q);
            const colorText = getComputedStyle(document.body).getPropertyValue('--text-secondary');
            const colorGrid = getComputedStyle(document.body).getPropertyValue('--chart-grid');
            Chart.defaults.color = colorText; Chart.defaults.borderColor = colorGrid;

            if(charts.h) charts.h.destroy();
            charts.h = new Chart(document.getElementById('chartHours'), {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Horas', data: dataH, backgroundColor: '#4caf50', borderRadius:4 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
            if(charts.q) charts.q.destroy();
            charts.q = new Chart(document.getElementById('chartQuestions'), {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Quest√µes', data: dataQ, backgroundColor: '#2196f3', borderRadius:4 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTopicTable(stats) {
            const tbody = document.getElementById('topTopicsBody'); tbody.innerHTML = '';
            const sorted = Object.entries(stats).sort((a,b) => b[1].q - a[1].q).slice(0, 10);
            sorted.forEach(([topic, data]) => {
                const pct = data.q>0 ? Math.round((data.c/data.q)*100) : 0;
                let col = 'var(--text-secondary)'; if(pct>=80) col='var(--success)'; else if(pct<60) col='var(--danger)';
                tbody.innerHTML += `<tr><td style="color:var(--text-primary)">${topic}</td><td>${data.q}</td><td>${data.c}</td><td style="color:${col}; font-weight:700">${pct}%</td></tr>`;
            });
        }

        function renderEdital() {
            const container = document.getElementById('editalContainer'); container.innerHTML = '';
            for(const [disc, topics] of Object.entries(editalDB)) {
                const total = topics.length; const done = topics.filter(t => appData.editalStatus[t]).length;
                const pct = Math.round((done/total)*100);
                const card = document.createElement('div'); card.className = 'discipline-card';
                card.innerHTML = `<div class="discipline-header" onclick="this.nextElementSibling.classList.toggle('open')"><div style="flex:1"><span style="font-weight:700; color:var(--accent); display:block; margin-bottom:5px;">${disc}</span><div style="display:flex; align-items:center; gap:10px;"><div style="width:100px; height:4px; background:var(--border); border-radius:2px;"><div style="width:${pct}%; height:100%; background:var(--success);"></div></div><span style="font-size:0.75rem; color:var(--text-secondary);">${pct}%</span></div></div><span>‚ñº</span></div><ul class="topic-list">${topics.map(t => {
                    const ck = appData.editalStatus[t] ? 'checked' : '';
                    const hours = calculateTopicHours(t);
                    const badgeClass = hours > 0 ? 'time-badge has-time' : 'time-badge';
                    return `<li class="topic-item"><div class="topic-left"><input type="checkbox" class="topic-check" ${ck} onchange="toggleTopic('${t}')"><span class="topic-text">${t}</span></div><div style="display:flex; align-items:center; gap:10px;"><span class="${badgeClass}">${hours.toFixed(1)}h</span><button class="add-btn-mini" onclick="askAddToPlan('${disc}', '${t}')">Agendar</button></div></li>`
                }).join('')}</ul>`;
                container.appendChild(card);
            }
        }

        window.toggleTopic = function(t) { appData.editalStatus[t] = !appData.editalStatus[t]; save(); renderEdital(); }

        window.switchView = function(v) { 
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active'); 
            event.currentTarget.classList.add('active');
            if(window.innerWidth <= 768) document.getElementById('navMenu').classList.remove('open');
            if(v === 'edital') renderEdital(); if(v === 'dashboard') updateDashboard();
        }
        window.setTheme = function(m) { 
            document.body.className = m+'-mode'; 
            document.getElementById('btnDark').classList.toggle('active', m==='dark');
            document.getElementById('btnLight').classList.toggle('active', m==='light');
            localStorage.setItem('bb_theme', m);
        }
        window.exportData = function() { const a=document.createElement('a'); a.href="data:json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData)); a.download="BB_Final_UI.json"; a.click(); }
        
        window.importData = function(e) { 
            const r=new FileReader(); 
            r.onload=x=>{ 
                try {
                    appData=JSON.parse(x.target.result); save(); location.reload(); 
                    // No modal needed here as reload happens instantly, but good practice for SPA would use showModal('success'...)
                } catch(err) {
                    showModal('danger', 'Erro no Arquivo', 'O arquivo selecionado n√£o √© um backup v√°lido.');
                }
            }; 
            r.readAsText(e.files[0]); 
        }

        init();
    </script>
</body>
</html>